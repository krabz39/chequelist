<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChequeSet Terminal</title>

<script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
:root {
    --bg-dark:#05090c;
    --bg-panel:#0c1218;
    --bg-panel-2:#0e1923;
    --bg-chart:#0b141d;
    --bg-chart-inner:#070c11;

    --text:#d9d9d9;
    --text-soft:#9bbcc9;

    --acc:#14d2b8;
    --acc-soft:rgba(20,210,184,0.20);

    --danger:#c0392b;
    --warn:#f1c40f;

    --sidebar-width:260px;
}

/* ============================= GLOBAL ============================== */
body{
    margin:0;
    padding:0;
    background:var(--bg-dark);
    color:var(--text);
    font-family:Inter,sans-serif;
    overflow:hidden;
}

#app{
    display:grid;
    grid-template-columns:var(--sidebar-width) 1fr 350px;
    height:100vh;
    width:100vw;
    transition:0.3s;
}

/* ============================= SIDEBAR ============================== */
#sidebar{
    background:linear-gradient(180deg,#0d1822,#0a1116,#091015);
    padding:18px;
    overflow-y:auto;
    border-right:1px solid rgba(255,255,255,0.06);
    transition:0.3s;
    z-index:9;
}

#sidebar h2{
    font-weight:600;
    color:var(--acc);
    margin:0 0 15px 0;
    font-size:20px;
}

.category{
    margin-top:18px;
    margin-bottom:8px;
    font-size:13px;
    letter-spacing:1px;
    opacity:0.6;
    text-transform:uppercase;
}

.instrument{
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,0.05);
    cursor:pointer;
    transition:0.25s;
    font-size:15px;
    border-radius:6px;
}

.instrument:hover{
    background:rgba(20,210,184,0.07);
    color:var(--acc);
    padding-left:18px;
}

.instrument.active{
    background:rgba(20,210,184,0.16);
    border-left:3px solid var(--acc);
    color:var(--acc);
    padding-left:18px;
}

/* ============================= CHART AREA ============================== */
#chartArea{
    padding:15px;
    background:var(--bg-chart);
}

#chart{
    height:75vh;
    background:var(--bg-chart-inner);
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.05);
}

/* TF BUTTONS */
#timeframes{
    margin-top:10px;
    white-space:nowrap;
    overflow-x:auto;
}

#timeframes button{
    background:#0f1821;
    color:var(--text-soft);
    border:1px solid #1d2c38;
    padding:6px 12px;
    border-radius:6px;
    margin-right:6px;
    cursor:pointer;
    font-size:14px;
}

#timeframes button.active{
    background:var(--acc);
    border-color:var(--acc);
    color:#000;
}

/* ============================= DASHBOARD ============================== */
#dashboard{
    background:linear-gradient(180deg,#0f1b26,#0c1218);
    padding:20px;
    overflow-y:auto;
    border-left:1px solid rgba(255,255,255,0.06);
}

#dashboard h2{
    margin:0 0 15px 0;
    color:var(--acc);
    font-weight:700;
    font-size:22px;
}

.bigScore{
    font-size:60px;
    font-weight:800;
    color:var(--acc);
    margin-bottom:8px;
    text-align:center;
}

#verdict{
    font-size:16px;
    padding:12px;
    border-radius:8px;
    margin-bottom:18px;
    background:#132028;
    text-align:center;
}

.metric{
    padding:14px;
    margin-bottom:12px;
    background:var(--bg-panel-2);
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.05);
}

.metric strong{ font-size:13px; opacity:0.75; }
.metric span{ font-size:20px; font-weight:700; color:var(--acc); }

/* ============================= MOBILE FIX ============================== */
@media(max-width:850px){

    body{ overflow:hidden; }

    #app{
        grid-template-columns:1fr;
    }

    /* SIDEBAR MOBILE */
    #sidebar{
        position:fixed;
        left:-260px;
        top:0;
        height:100vh;
        width:260px;
        background:#0a131b;
        z-index:20;
        transition:0.3s;
    }
    #sidebar.open{ left:0; }

    /* DASHBOARD MOBILE */
    #dashboard{
        position:fixed;
        bottom:-85vh;
        left:0;
        width:100%;
        height:85vh;
        border-radius:22px 22px 0 0;
        z-index:19;
        transition:0.3s;
        border-top:2px solid var(--acc-soft);
    }

    #dashboard.open{ bottom:0; }

    #chart{
        height:62vh;
    }

    /* FLOAT BUTTONS */
    #hamburger{
        display:block;
        z-index:40;
        position:fixed;
        top:15px;
        left:15px;
        font-size:30px;
        color:white;
        cursor:pointer;
    }

    #dashToggle{
        display:block;
        position:fixed;
        bottom:15px;
        right:15px;
        background:var(--acc);
        color:black;
        font-size:22px;
        padding:12px 16px;
        border-radius:50%;
        cursor:pointer;
        z-index:40;
        font-weight:bold;
    }
}

#hamburger{ display:none; }
#dashToggle{ display:none; }

</style>
</head>

<body>

<div id="hamburger">☰</div>
<div id="dashToggle">▲</div>

<audio id="snd_checkmate" src="/static/sounds/checkmate.wav"></audio>
<audio id="snd_warning" src="/static/sounds/warning.wav"></audio>
<audio id="snd_error"   src="/static/sounds/error.wav"></audio>

<div id="app">

    <!-- SIDEBAR -->
    <div id="sidebar">
        <h2>Markets</h2>

        <div class="category">FOREX MAJORS</div>
        <div class="instrument active" data-map="XAU/USD">XAUUSD</div>
        <div class="instrument" data-map="EUR/USD">EURUSD</div>
        <div class="instrument" data-map="GBP/USD">GBPUSD</div>
        <div class="instrument" data-map="USD/JPY">USDJPY</div>
        <div class="instrument" data-map="USD/CAD">USDCAD</div>
        <div class="instrument" data-map="USD/CHF">USDCHF</div>

        <div class="category">INDICES</div>
        <div class="instrument" data-map="US30">US30</div>
        <div class="instrument" data-map="NAS100">NAS100</div>
        <div class="instrument" data-map="SPX500">SPX500</div>
        <div class="instrument" data-map="GER40">GER40</div>

        <div class="category">CRYPTO</div>
        <div class="instrument" data-map="BTC/USD">BTCUSD</div>
        <div class="instrument" data-map="ETH/USD">ETHUSD</div>

        <div class="category">SYNTHETICS</div>
        <div class="instrument" data-map="R_75">VIX75</div>
        <div class="instrument" data-map="R_100">Volatility100</div>
        <div class="instrument" data-map="BOOM1000">Boom1000</div>
        <div class="instrument" data-map="CRASH1000">Crash1000</div>
    </div>

    <!-- CHART -->
    <div id="chartArea">
        <div id="chart"></div>

        <div id="timeframes">
            <button class="tf-btn active" data-tf="1min">1min</button>
            <button class="tf-btn" data-tf="5min">5min</button>
            <button class="tf-btn" data-tf="15min">15min</button>
            <button class="tf-btn" data-tf="30min">30min</button>
            <button class="tf-btn" data-tf="1h">1h</button>
            <button class="tf-btn" data-tf="4h">4h</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <h2>ChequeSet Score</h2>

        <div class="bigScore" id="scoreValue">--</div>
        <div id="verdict">Waiting...</div>

        <div class="metric"><strong>Trend Strength</strong><span id="m_trend">--</span></div>
        <div class="metric"><strong>Momentum (QQE)</strong><span id="m_momentum">--</span></div>
        <div class="metric"><strong>Arrow Signals</strong><span id="m_arrows">--</span></div>
        <div class="metric"><strong>Liquidity Quality</strong><span id="m_liquidity">--</span></div>
        <div class="metric"><strong>Market Structure</strong><span id="m_structure">--</span></div>
        <div class="metric"><strong>Order Blocks</strong><span id="m_ob">--</span></div>
        <div class="metric"><strong>BOS / CHOCH</strong><span id="m_bos">--</span></div>
        <div class="metric"><strong>Candle Timing</strong><span id="m_time">--</span></div>
        <div class="metric"><strong>Market Bias</strong><span id="m_bias">--</span></div>
        <div class="metric"><strong>Risk Meter</strong><span id="m_risk">--</span></div>
        <div class="metric"><strong>Session Strength</strong><span id="m_session">--</span></div>
    </div>

</div>

<!-- ENGINE FILES -->
<script src="/static/core/ama.js"></script>
<script src="/static/core/qqe.js"></script>
<script src="/static/core/arrows.js"></script>
<script src="/static/core/liquidity.js"></script>
<script src="/static/core/trendStructure.js"></script>
<script src="/static/core/orderBlocks.js"></script>
<script src="/static/core/breakerStructure.js"></script>
<script src="/static/core/scoring.js"></script>
<script src="/static/core/chartEngine.js"></script>
<script src="/static/core/liquidityStructureRenderer.js"></script>
<script src="/static/core/orderBlockRenderer.js"></script>
<script src="/static/core/bosChochRenderer.js"></script>
<script src="/static/core/candleTimer.js"></script>

<script>
let currentSymbol="XAU/USD";
let currentTF="1min";

/* ✅ FIX: BIND ALL METRIC ELEMENTS */
const m_trend     = document.getElementById("m_trend");
const m_momentum  = document.getElementById("m_momentum");
const m_arrows    = document.getElementById("m_arrows");
const m_liquidity = document.getElementById("m_liquidity");
const m_structure = document.getElementById("m_structure");
const m_ob        = document.getElementById("m_ob");
const m_bos       = document.getElementById("m_bos");
const m_time      = document.getElementById("m_time");
const m_bias      = document.getElementById("m_bias");
const m_risk      = document.getElementById("m_risk");
const m_session   = document.getElementById("m_session");

const scoreValue  = document.getElementById("scoreValue");
const verdict     = document.getElementById("verdict");

/* MOBILE TOGGLES */
document.getElementById("hamburger").onclick=()=>{
    document.getElementById("sidebar").classList.toggle("open");
};

document.getElementById("dashToggle").onclick=()=>{
    document.getElementById("dashboard").classList.toggle("open");
};

async function fetchCandles(){
    try{
        const r=await fetch(`/api/candles?symbol=${encodeURIComponent(currentSymbol)}&tf=${currentTF}`);
        return await r.json();
    }catch{ return []; }
}

async function updateChart(){
    const candles=await fetchCandles();
    if(candles.length<5) return;

    updateCandles(candles);

    const ama=calculateAMA(candles);
    const qqe=calculateQQE(candles);
    const arrows=calculateArrows(candles);
    const liq=detectLiquidity(candles);

    m_trend.textContent=getAMATrend(ama);
    m_momentum.textContent=getQQEState(qqe);
    m_arrows.textContent=arrows.length;
    m_liquidity.textContent=liq.fvg.length+liq.eqh.length+liq.eql.length;
    m_structure.textContent=detectStructure(candles).length;
    m_ob.textContent=detectOrderBlocks(candles).length;
    m_bos.textContent=detectBOSCHOCH(candles).length;
    m_time.textContent="OK";
    m_bias.textContent=getAMATrend(ama)==="up"?"Bullish":"Bearish";
    m_risk.textContent=qqe.length>0?"Normal":"--";
    m_session.textContent="Active";

    const score=calculateScore(
        getAMATrend(ama),
        getQQEState(qqe),
        arrows,
        liq,
        true
    );

    scoreValue.textContent=score;

    if(score>=80){
        verdict.textContent="CHECKMATE: TRADE VALID";
        verdict.style.background="#14d2b8";
        verdict.style.color="black";
    } 
    else if(score>=60){
        verdict.textContent="High Risk – WAIT";
        verdict.style.background="#f1c40f";
        verdict.style.color="black";
    } 
    else {
        verdict.textContent="NO TRADE";
        verdict.style.background="#c0392b";
        verdict.style.color="white";
    }
}

document.querySelectorAll(".instrument").forEach(el=>{
    el.onclick=()=>{
        document.querySelectorAll(".instrument").forEach(x=>x.classList.remove("active"));
        el.classList.add("active");
        currentSymbol=el.dataset.map;
        clearChart();
        updateChart();
    };
});

document.querySelectorAll(".tf-btn").forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll(".tf-btn").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        currentTF=btn.dataset.tf;
        clearChart();
        updateChart();
    };
});

initChart("chart");
setInterval(updateChart,1500);
updateChart();
</script>

</body>
</html>
